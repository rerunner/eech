; Listing generated by Microsoft (R) Optimizing Compiler Version 19.16.27045.0 

	TITLE	C:\Users\nhv90\Projects\eech\aphavoc\source\ui_menu\session\mission.c
	.686P
	.XMM
	include listing.inc
	.model	flat

INCLUDELIB MSVCRTD
INCLUDELIB OLDNAMES

PUBLIC	?leave_mission@@YGXXZ				; leave_mission
EXTRN	?direct_play_close_session@@YGHXZ:PROC		; direct_play_close_session
EXTRN	?direct_play_destroy_player@@YGHXZ:PROC		; direct_play_destroy_player
EXTRN	?direct_play_get_connection_data@@YGPAUCONNECTION_DATA_TYPE@@XZ:PROC ; direct_play_get_connection_data
EXTRN	?direct_play_set_session_type_and_name@@YGXH@Z:PROC ; direct_play_set_session_type_and_name
EXTRN	?reset_comms_data@@YGXXZ:PROC			; reset_comms_data
EXTRN	?send_packet@@YGXKW4PACKET_TYPES@@PAEHW4SEND_TYPES@@@Z:PROC ; send_packet
EXTRN	?comms_clear_data_record@@YGXXZ:PROC		; comms_clear_data_record
EXTRN	?unregister_connection@@YGXK@Z:PROC		; unregister_connection
EXTRN	?get_connection_list_head@@YGPAUCONNECTION_LIST_TYPE@@XZ:PROC ; get_connection_list_head
EXTRN	?destroy_local_entities@@YGXXZ:PROC		; destroy_local_entities
EXTRN	?destroy_local_only_entities@@YGXXZ:PROC	; destroy_local_only_entities
EXTRN	?set_current_game_session@@YGXPAUSESSION_LIST_DATA_TYPE@@@Z:PROC ; set_current_game_session
EXTRN	?destroy_campaign@@YGXXZ:PROC			; destroy_campaign
EXTRN	?system_comms_model@@3W4COMMS_MODEL_TYPES@@A:DWORD ; system_comms_model
EXTRN	?system_server_id@@3KA:DWORD			; system_server_id
EXTRN	?entities@@3PAUENTITY@@A:DWORD			; entities
EXTRN	?gunship_entity@@3PAUENTITY@@A:DWORD		; gunship_entity
EXTRN	?exit_flight_loop_flag@@3HA:DWORD		; exit_flight_loop_flag
EXTRN	?current_game_session@@3PAUSESSION_LIST_DATA_TYPE@@A:DWORD ; current_game_session
EXTRN	?valid_helicopter@@3HA:DWORD			; valid_helicopter
; Function compile flags: /Odtp /ZI
; File c:\users\nhv90\projects\eech\aphavoc\source\ui_menu\session\mission.c
;	COMDAT ?leave_mission@@YGXXZ
_TEXT	SEGMENT
_comms_connection$ = -16				; size = 4
_connection$ = -12					; size = 4
_destroy_connection$ = -8				; size = 4
_index_number$ = -4					; size = 4
?leave_mission@@YGXXZ PROC				; leave_mission, COMDAT

; 82   : {

  00000	55		 push	 ebp
  00001	8b ec		 mov	 ebp, esp
  00003	83 ec 50	 sub	 esp, 80			; 00000050H
  00006	53		 push	 ebx
  00007	56		 push	 esi
  00008	57		 push	 edi

; 83   : 
; 84   : 	int
; 85   : 		index_number;
; 86   : 
; 87   : 	connection_list_type
; 88   : 		*destroy_connection,
; 89   : 		*connection;
; 90   : 
; 91   :    connection_data_type
; 92   :       *comms_connection;
; 93   : 
; 94   : 	#if DEBUG_MODULE
; 95   : 
; 96   : 	debug_log ("MISSION: leaving");
; 97   : 
; 98   : 	#endif
; 99   : 
; 100  :         if (get_valid_current_game_session ())

  00009	83 3d 00 00 00
	00 00		 cmp	 DWORD PTR ?current_game_session@@3PAUSESSION_LIST_DATA_TYPE@@A, 0 ; current_game_session
  00010	0f 84 df 00 00
	00		 je	 $LN1@leave_miss

; 101  : 	{
; 102  : 
; 103  : 		//
; 104  : 		// comms stuff
; 105  : 		//
; 106  : 
; 107  : 		if (get_comms_model () == COMMS_MODEL_CLIENT)

  00016	83 3d 00 00 00
	00 01		 cmp	 DWORD PTR ?system_comms_model@@3W4COMMS_MODEL_TYPES@@A, 1 ; system_comms_model
  0001d	75 27		 jne	 SHORT $LN5@leave_miss

; 108  : 		{
; 109  : 
; 110  : 			index_number = get_local_entity_index (get_gunship_entity ());

  0001f	a1 00 00 00 00	 mov	 eax, DWORD PTR ?gunship_entity@@3PAUENTITY@@A ; gunship_entity
  00024	2b 05 00 00 00
	00		 sub	 eax, DWORD PTR ?entities@@3PAUENTITY@@A ; entities
  0002a	c1 f8 04	 sar	 eax, 4
  0002d	89 45 fc	 mov	 DWORD PTR _index_number$[ebp], eax

; 111  : 
; 112  : 			#if DEBUG_MODULE
; 113  : 
; 114  : 			debug_log ("MISSION: Sending END GAME to server");
; 115  : 
; 116  : 			#endif
; 117  : 
; 118  : 
; 119  : ////Moje 040618	Leave the player removal to cvc ;)
; 120  : 	send_packet (get_server_id (), PACKET_TYPE_END_GAME, (unsigned char *) &index_number, 4, SEND_TYPE_PERSONAL);

  00030	6a 00		 push	 0
  00032	6a 04		 push	 4
  00034	8d 45 fc	 lea	 eax, DWORD PTR _index_number$[ebp]
  00037	50		 push	 eax
  00038	6a 0e		 push	 14			; 0000000eH
  0003a	8b 0d 00 00 00
	00		 mov	 ecx, DWORD PTR ?system_server_id@@3KA ; system_server_id
  00040	51		 push	 ecx
  00041	e8 00 00 00 00	 call	 ?send_packet@@YGXKW4PACKET_TYPES@@PAEHW4SEND_TYPES@@@Z ; send_packet
$LN5@leave_miss:

; 121  : // Jabberwock 050320 - Restored, should work now
; 122  : 		}
; 123  : 
; 124  :       connection = get_connection_list_head ();

  00046	e8 00 00 00 00	 call	 ?get_connection_list_head@@YGPAUCONNECTION_LIST_TYPE@@XZ ; get_connection_list_head
  0004b	89 45 f4	 mov	 DWORD PTR _connection$[ebp], eax
$LN2@leave_miss:

; 125  : 
; 126  :       while (connection)

  0004e	83 7d f4 00	 cmp	 DWORD PTR _connection$[ebp], 0
  00052	74 38		 je	 SHORT $LN3@leave_miss

; 127  :       {
; 128  : 
; 129  :          destroy_connection = connection;

  00054	8b 45 f4	 mov	 eax, DWORD PTR _connection$[ebp]
  00057	89 45 f8	 mov	 DWORD PTR _destroy_connection$[ebp], eax

; 130  : 
; 131  :          connection = connection->next;

  0005a	8b 45 f4	 mov	 eax, DWORD PTR _connection$[ebp]
  0005d	8b 48 3c	 mov	 ecx, DWORD PTR [eax+60]
  00060	89 4d f4	 mov	 DWORD PTR _connection$[ebp], ecx

; 132  : 
; 133  :          if (get_comms_model () == COMMS_MODEL_SERVER)

  00063	83 3d 00 00 00
	00 00		 cmp	 DWORD PTR ?system_comms_model@@3W4COMMS_MODEL_TYPES@@A, 0 ; system_comms_model
  0006a	75 13		 jne	 SHORT $LN6@leave_miss

; 134  :          {
; 135  : 
; 136  :             send_packet (destroy_connection->connection_id, PACKET_TYPE_SERVER_REJECTED, NULL, 0, SEND_TYPE_PERSONAL);

  0006c	6a 00		 push	 0
  0006e	6a 00		 push	 0
  00070	6a 00		 push	 0
  00072	6a 0d		 push	 13			; 0000000dH
  00074	8b 45 f8	 mov	 eax, DWORD PTR _destroy_connection$[ebp]
  00077	8b 08		 mov	 ecx, DWORD PTR [eax]
  00079	51		 push	 ecx
  0007a	e8 00 00 00 00	 call	 ?send_packet@@YGXKW4PACKET_TYPES@@PAEHW4SEND_TYPES@@@Z ; send_packet
$LN6@leave_miss:

; 137  :          }
; 138  : 
; 139  :          unregister_connection (destroy_connection->connection_id);

  0007f	8b 45 f8	 mov	 eax, DWORD PTR _destroy_connection$[ebp]
  00082	8b 08		 mov	 ecx, DWORD PTR [eax]
  00084	51		 push	 ecx
  00085	e8 00 00 00 00	 call	 ?unregister_connection@@YGXK@Z ; unregister_connection

; 140  : 
; 141  : 
; 142  :       }

  0008a	eb c2		 jmp	 SHORT $LN2@leave_miss
$LN3@leave_miss:

; 143  : 
; 144  : 		comms_connection = direct_play_get_connection_data ();

  0008c	e8 00 00 00 00	 call	 ?direct_play_get_connection_data@@YGPAUCONNECTION_DATA_TYPE@@XZ ; direct_play_get_connection_data
  00091	89 45 f0	 mov	 DWORD PTR _comms_connection$[ebp], eax

; 145  : 
; 146  : 		if ( ( comms_connection ) && ( comms_connection->is_initialised ) )

  00094	83 7d f0 00	 cmp	 DWORD PTR _comms_connection$[ebp], 0
  00098	74 27		 je	 SHORT $LN7@leave_miss
  0009a	8b 45 f0	 mov	 eax, DWORD PTR _comms_connection$[ebp]
  0009d	8b 48 3c	 mov	 ecx, DWORD PTR [eax+60]
  000a0	83 e1 01	 and	 ecx, 1
  000a3	74 1c		 je	 SHORT $LN7@leave_miss

; 147  : 		{
; 148  : 
; 149  : 			if ( !comms_connection->one_way_hosting_setup )

  000a5	8b 45 f0	 mov	 eax, DWORD PTR _comms_connection$[ebp]
  000a8	83 78 38 00	 cmp	 DWORD PTR [eax+56], 0
  000ac	75 0c		 jne	 SHORT $LN8@leave_miss

; 150  : 			{
; 151  : 			// Jabberwock 050303 Remove DP groups
; 152  : 			//	direct_play_leave_group ();
; 153  : 
; 154  : 				direct_play_destroy_player ();

  000ae	e8 00 00 00 00	 call	 ?direct_play_destroy_player@@YGHXZ ; direct_play_destroy_player

; 155  : 
; 156  : 				if (get_comms_model () == COMMS_MODEL_SERVER)
; 157  : 				{
; 158  : 				// Jabberwock 050303 Remove DP groups
; 159  : 				//	direct_play_destroy_group ();
; 160  : 				}
; 161  : 
; 162  : 				direct_play_close_session ();

  000b3	e8 00 00 00 00	 call	 ?direct_play_close_session@@YGHXZ ; direct_play_close_session

; 163  : 			}
; 164  : 			else

  000b8	eb 07		 jmp	 SHORT $LN7@leave_miss
$LN8@leave_miss:

; 165  : 			{
; 166  : 
; 167  : 				direct_play_set_session_type_and_name ( GAME_TYPE_INVALID );

  000ba	6a 00		 push	 0
  000bc	e8 00 00 00 00	 call	 ?direct_play_set_session_type_and_name@@YGXH@Z ; direct_play_set_session_type_and_name
$LN7@leave_miss:

; 168  : 			}
; 169  : 		}
; 170  : 
; 171  : 		//
; 172  : 		// Deinit stuff,
; 173  : 		//
; 174  : 
; 175  : 		set_current_game_session_invalid ();

  000c1	6a 00		 push	 0
  000c3	e8 00 00 00 00	 call	 ?set_current_game_session@@YGXPAUSESSION_LIST_DATA_TYPE@@@Z ; set_current_game_session

; 176  : 
; 177  : 		set_valid_helicopter (FALSE);

  000c8	c7 05 00 00 00
	00 00 00 00 00	 mov	 DWORD PTR ?valid_helicopter@@3HA, 0 ; valid_helicopter

; 178  : 
; 179  :       destroy_local_entities ();

  000d2	e8 00 00 00 00	 call	 ?destroy_local_entities@@YGXXZ ; destroy_local_entities

; 180  : 
; 181  : 		destroy_local_only_entities ();

  000d7	e8 00 00 00 00	 call	 ?destroy_local_only_entities@@YGXXZ ; destroy_local_only_entities

; 182  : 
; 183  : 		reset_comms_data ();

  000dc	e8 00 00 00 00	 call	 ?reset_comms_data@@YGXXZ ; reset_comms_data

; 184  : 
; 185  : 		comms_clear_data_record ();

  000e1	e8 00 00 00 00	 call	 ?comms_clear_data_record@@YGXXZ ; comms_clear_data_record

; 186  : 
; 187  : 		destroy_campaign ();

  000e6	e8 00 00 00 00	 call	 ?destroy_campaign@@YGXXZ ; destroy_campaign

; 188  : 
; 189  :       //
; 190  :       // Stop the game loop
; 191  :       //
; 192  : 
; 193  : 		set_exit_flight_loop (TRUE);

  000eb	c7 05 00 00 00
	00 01 00 00 00	 mov	 DWORD PTR ?exit_flight_loop_flag@@3HA, 1 ; exit_flight_loop_flag
$LN1@leave_miss:

; 194  :    }
; 195  : }

  000f5	5f		 pop	 edi
  000f6	5e		 pop	 esi
  000f7	5b		 pop	 ebx
  000f8	8b e5		 mov	 esp, ebp
  000fa	5d		 pop	 ebp
  000fb	c3		 ret	 0
?leave_mission@@YGXXZ ENDP				; leave_mission
_TEXT	ENDS
END
